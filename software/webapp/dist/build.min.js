function displayIMU(n){displayRotation(n)}function displayRotation(n){var e=$("#info-rotation").find("label span");e[0].innerHTML=Math.round(n.x)+"°",e[1].innerHTML=Math.round(n.y)+"°",e[2].innerHTML=Math.round(n.z)+"°"}function displayStatus(n,e){1===e||$("#btn_connect").text("Connect").off().click(onBtnConnectClick),panelClasses.forEach(function(n){$("#panel_connectionStatus").removeClass(n)}),connectionStatusClasses.forEach(function(n){$("#connection_status").removeClass(n)}),$("#panel_connectionStatus").addClass(panelClasses[e-1]),$("#connection_status").addClass(connectionStatusClasses[e-1]).text(n)}function displayMotors(n){var e=0,o="";n.forEach(function(n,t){e=Number(100*n/255).toFixed(2),$("#motor"+t).find("label").text(e),$("#control"+t).val(e),motorSpeedClasses.forEach(function(n){$("#motor"+t+"+.progress .progress-bar").removeClass(n)}),o=motorSpeedClasses[Math.floor(e/25)],$("#motor"+t+"+.progress .progress-bar").css("width",e+"%").addClass(o)})}function app_connect(){function n(){console.info("Connected to the server"),sendEvent("/uiConnect"),displayStatus("Connected",1)}var e=this;e.socket=new Faye.Client("http://localhost:8000/"),n(),e.socket.subscribe("/j5_imu",onIMUData),e.socket.subscribe("/j5_calibration",onIMUCalibration),e.socket.subscribe("/j5_motorSpeed",onMotorSpeed),e.socket.subscribe("/j5_settings",onServerSettings)}function onServerSettings(n){$("#pitch").val(n.pitch),$("#roll").val(n.roll),$("#yaw").val(n.yaw)}function onMotorSpeed(n){displayMotors(n)}function onIMUCalibration(n){droneRender.calibrate(n)}function onIMUData(n){displayIMU(n),droneRender.updateDroneRotation(n)}function sendEvent(n,e){app.socket.publish(n,e?e:{})}function app_initJoystick(){function n(){stickJS.GAMEPAD_0.on("left",onLeft),stickJS.GAMEPAD_0.on("right",onRight),stickJS.GAMEPAD_0.on("up",onUp),stickJS.GAMEPAD_0.on("down",onDown),stickJS.GAMEPAD_0.on("button2",onFlyUp),stickJS.GAMEPAD_0.on("button3",onFlyDown),stickJS.GAMEPAD_0.on("start",onWakeUp)}stickJS.init(n)}function onWakeUp(){console.log("WAKE UP !"),sendEvent("/wakeUp")}function onFlyUp(){sendEvent("/flyUp")}function onFlyDown(){sendEvent("/flyDown")}function onIDLE(){sendEvent("/idle")}function onLeft(){sendEvent("/rotateLeft")}function onRight(){sendEvent("/rotateRight")}function onUp(){sendEvent("/forward")}function onDown(){sendEvent("/backward")}function createRender(){this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(this.WIDTH,this.HEIGHT),this.camera=new THREE.PerspectiveCamera(this.VIEW_ANGLE,this.ASPECT,this.NEAR,this.FAR),this.camera.position.x=0,this.camera.position.y=400,this.camera.position.z=550,this.scene=new THREE.Scene,this.scene.add(new THREE.AxisHelper(3e3)),this.light=this.createLight(200,200,200),floor=new createBox(200,300,2),floor.position.y=0,this.scene.add(this.camera),this.scene.add(this.light),this.scene.add(floor),this.container.append(this.renderer.domElement),this.camera.lookAt(floor.position),requestAnimationFrame(this.render)}function createLight(n,e,o){var t=new THREE.PointLight(16777215);return t.position.x=n,t.position.y=e,t.position.z=o,t}function render(){droneRender.renderer.render(droneRender.scene,droneRender.camera);try{droneRender.camera.lookAt(floor.position)}catch(n){console.warn("DroneRenderer on render: ",n)}requestAnimationFrame(droneRender.render)}function calibrate(n){droneRender.settings.rotationX=Math.round(n.x),droneRender.settings.rotationY=Math.round(n.y),droneRender.settings.rotationZ=Math.round(n.z)}function updateDroneRotation(n){Math.round(droneRender.settings.rotationX-n.x)&&(floor.rotation.z=n.x*Math.PI/180),Math.round(droneRender.settings.rotationY-n.y)&&(floor.rotation.x=n.y*Math.PI/180),Math.round(droneRender.settings.rotationZ-n.z),droneRender.settings.rotationX=n.x,droneRender.settings.rotationY=n.y,droneRender.settings.rotationZ=n.z}function createBox(n,e,o){var t=new THREE.CubeGeometry(n,o,e),i=new THREE.MeshLambertMaterial({color:15461355}),r=new THREE.Mesh(t,i);return r}function app_domReady(){$("#btn_connect").click(onBtnConnectClick),$(".btn-change").click(onBtnChangeClick),$("#controlForm input").change(onInputModeChange),droneRender.createRender(),app.initJoystick()}function app_updateControlMode(){switch(app.CONTROL_MODE){case"joystick":app.initJoystick();break;case"keyboard":app.initKeyboard();break;case"voice":app.initVoice()}}function app_initKeyboard(){function n(n){var e={113:"0",119:"1",101:2,114:3},o={97:"0",115:"1",100:2,102:3};("".concat(n.which||n.keycode)in e||"".concat(n.which||n.keycode)in o||111==(n.which||n.keycode)||108==(n.which||n.keycode))&&(111==(n.which||n.keycode)||108==(n.which||n.keycode)?sendEvent("/customMotor",{all:!0,fwd:111==(n.which||n.keycode)}):sendEvent("/customMotor",{id:e["".concat(n.which||n.keycode)]||o["".concat(n.which||n.keycode)],fwd:"".concat(n.which||n.keycode)in e}))}$(document).off("keypress").on("keypress",n)}function app_parseVoiceCommands(){console.log("Voice: ",app.voiceCommand),app.voiceCommand in app.VOICE_COMMANDS_UP&&(console.log("Flying up"),sendEvent("/flyUp")),app.voiceCommand in app.VOICE_COMMANDS_DOWN&&(console.log("Flying down"),sendEvent("/flyDown")),app.voiceCommand in app.VOICE_COMMANDS_START&&(console.log("Wake uping"),sendEvent("/wakeUp"))}function app_initVoice(){app.recognition&&app.recognition.stop(),app.recognition=new webkitSpeechRecognition,app.recognition.continuous=!0,app.recognition.lang="es-AR",app.recognition.onerror=function(n){console.warn("Voice commands error: ",n)},app.recognition.onresult=function(n){for(var e=n.resultIndex;e<n.results.length;e++)n.results[e].isFinal&&(app.voiceCommand=n.results[e][0].transcript.toLowerCase());app.parseVoiceCommands()},app.recognition.start()}function onBtnConnectClick(){app.connect()}function onInputModeChange(n){$(n.target).val()&&(app.recognition&&app.recognition.stop(),app.CONTROL_MODE=$(n.target).val().toLowerCase(),app.updateControlMode())}function onBtnChangeClick(n){var e=$(n.currentTarget).parent().find("input").attr("id"),o=$("#"+e).val(),t={};t[e]=o,sendEvent("/client_settings",t)}var panelClasses=["panel-info","panel-danger","panel-warning"],connectionStatusClasses=["text-success","text-danger","text-warning"],motorSpeedClasses=["progress-bar-info","progress-bar-success","progress-bar-warning","progress-bar-danger"],motorId=0,droneRenderSettings={calibrateX:0,calibrateY:0,calibrateZ:0,lastX:0,lastY:0,lastZ:0,lastUpdate:0,calibrateTime:0},droneRender={WIDTH:$("#droneRender").width(),HEIGHT:$("#droneRender").height(),VIEW_ANGLE:45,NEAR:10,FAR:1e3,container:$("#droneRender"),settings:droneRenderSettings,createRender:createRender,createLight:createLight,render:render,calibrate:calibrate,updateDroneRotation:updateDroneRotation};droneRender.ASPECT=droneRender.WIDTH/droneRender.HEIGHT;var ROTATION_CONSTANT=6,sphereRotation=0,floor,ROTATION_FIX=.04,app={IP_SERVER:"http://127.0.0.1:8000",CONTROL_MODE:"keyboard",VOICE_COMMANDS_UP:{flotar:0,volar:0,"volar arriba":0,"flotar arriba":0},VOICE_COMMANDS_DOWN:{bajar:0,descender:0,"volar abajo":0},VOICE_COMMANDS_START:{despierta:0},domReady:app_domReady,connect:app_connect,initJoystick:app_initJoystick,initKeyboard:app_initKeyboard,initVoice:app_initVoice,updateControlMode:app_updateControlMode,parseVoiceCommands:app_parseVoiceCommands};$(document).ready(app.domReady);